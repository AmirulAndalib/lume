<title>Игорь & Анна</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
	html,
	body {
		width: 100%;
		height: 100%;
		margin: 0;
		padding: 0;
		touch-action: none;
		user-select: none;
	}

	html {
		overflow: hidden;
		background-image: linear-gradient(
			159deg,
			rgb(228, 236, 232) 0%,
			rgb(220, 231, 226) 35%,
			rgb(201, 217, 209) 64%,
			rgb(127, 164, 145) 100%
		);
	}

	lume-scene {
		position: absolute;
		top: 0;
		left: 0;
	}

	lume-scene * {
		/* pointer-events: none; */
	}

	.rays {
		position: absolute;
		top: -140%;
		left: -140%;
		width: 250%;
		height: 250%;
		pointer-events: none;

		background-image: repeating-conic-gradient(hsla(0, 0%, 100%, 0.2) 0 5deg, hsla(0, 0%, 100%, 0) 0 15deg);
	}

	#fitted {
		/* background: #fbfaf4; */
	}

	img,
	div,
	div canvas {
		width: 100%;
		height: 100%;
		display: block;
	}

	div {
		overflow: hidden;
	}
	img {
		/* transform: scale(1.01); */
	}

	#play {
		pointer-events: all;
	}

	:root {
		--green: #a3beb0;
	}

	.triangle {
		--size: 20;
		width: 0;
		height: 0;
		border-top: calc(1px * var(--size) / 2) solid transparent;
		border-bottom: calc(1px * var(--size) / 2) solid transparent;
		border-left: calc(1px * var(--size) / 2) solid var(--green);

		margin: auto;
	}

	.pause {
		display: none;
	}

	.pause::before,
	.pause::after {
		content: '';
		width: 20%;
		height: 80%;
		position: absolute;
		top: 50%;
		transform: translate(-50%, -50%);
		background: var(--green);
	}

	.pause::before {
		left: 30%;
	}

	.pause::after {
		left: 70%;
	}

	.showPause .pause {
		display: block;
	}
	.showPause .triangle {
		display: none;
	}
</style>

<body touch-action="none">
	<script src="../../dist/global.js"></script>
	<script>
		// Define all the LUME elements with their default names.
		LUME.useDefaultNames()
	</script>

	<!-- FIXME: this works if loaded here, but doesn't work if loaded after the
	 lume-scene markup. When loaded after the scene markup, _loadGL and similar
	 methods never fire. Maybe the ShadowDOM composition stuff needs to use
	 whenDefined() to wait for element definitions? -->
	<script src="./svg.js"></script>

	<script>
		async function svgTexture(plane, img, canvas) {
			const ctx = canvas.getContext('2d')

			await Promise.all([imgLoaded(img), glLoaded(plane)])

			console.log('IMAGE LOADED')
			canvas.width = 1294
			canvas.height = 2300
			ctx.drawImage(img, 0, 0, 1294, 2300)

			const tex = new LUME.THREE.CanvasTexture(canvas)
			plane.three.material.map = tex
			plane.three.material.needsUpdate = true
			plane.needsUpdate()

			// If we remove the canvas before the above creation of CanvasTexture, the texture will not render. hmmmm.
			canvas.remove()

			img.remove()
		}

		function imgLoaded(img) {
			return new Promise(res => (img.onload = res))
		}

		function glLoaded(node) {
			return new Promise(res => {
				if (node._glLoaded) res()
				else node.on('GL_LOAD', res)
			})
		}
	</script>

	<lume-scene
		id="scene"
		perspective="800"
		webgl
		enable-css="false"
		fog-mode="linear"
		fog-near="800"
		fog-far="1300"
		fog-color="#c3d5cc"
		swap-layers="true"
	>
		<lume-ambient-light color="white" intensity="0.8"></lume-ambient-light>

		<lume-point-light
			id="light"
			position="-960 -335 400"
			Xposition="0 0 400"
			align-point="0.5 0.5"
			intensity="0.6"
			color="white"
			shadow-radius="2"
			shadow-bias="-0.002"
		></lume-point-light>

		<lume-node
			id="fitter"
			size-mode="proportional proportional"
			size="0.9 0.9"
			align-point="0.5 0.5"
			mount-point="0.5 0.5"
		>
			<lume-plane id="fitted" align-point="0.5 0.5" mount-point="0.5 0.5" size="647 1150" color="#eee">
				<lume-plane
					id="bgPlane"
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 75"
					opacity="0.99"
					Xtexture="./bg.png"
					color="white"
				>
					<div>
						<canvas id="bgCanvas"></canvas>
						<img id="bgImg" src="./bg.png" width="1294" height="2300" />
					</div>
				</lume-plane>
				<script>
					svgTexture(bgPlane, bgImg, bgCanvas)
				</script>

				<lume-plane
					id="textPlane"
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 60"
					opacity="0.99"
					Xtexture="./text.svg"
					color="white"
				>
					<div>
						<canvas id="textCanvas"></canvas>
						<img id="textImg" src="./text.svg" width="1294" height="2300" />
					</div>
				</lume-plane>
				<script>
					svgTexture(textPlane, textImg, textCanvas)
				</script>

				<!-- <lume-svg size="500 500" src="./anna.svg"></lume-svg> -->
				<lume-plane
					id="annaPlane"
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 90"
					opacity="0.99"
					Xtexture="./anna.svg"
					color="white"
				>
					<div>
						<canvas id="annaCanvas"></canvas>
						<img id="annaImg" src="./anna.svg" width="1294" height="2300" />
					</div>
				</lume-plane>
				<script>
					svgTexture(annaPlane, annaImg, annaCanvas)
				</script>

				<!-- ///////////////////////////////////////////////////////////////////////////////////////// -->
				<!-- <lume-svg size="500 500" src="./and.svg"></lume-svg> -->
				<lume-svg-2
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 60"
					src="./and.svg"
				></lume-svg-2>
				<lume-plane
					id="andPlane"
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 60"
					opacity="0.99"
					Xtexture="./and.svg"
					color="white"
				>
					<div>
						<canvas id="andCanvas"></canvas>
						<img id="andImg" src="./and.svg" width="1294" height="2300" />
					</div>
				</lume-plane>
				<script>
					svgTexture(andPlane, andImg, andCanvas)
				</script>
				<!-- ///////////////////////////////////////////////////////////////////////////////////////// -->

				<lume-plane
					id="igorPlane"
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 90"
					opacity="0.99"
					Xtexture="./igor.svg"
					color="white"
				>
					<div>
						<canvas id="igorCanvas"></canvas>
						<img id="igorImg" src="./igor.svg" width="1294" height="2300" />
					</div>
				</lume-plane>
				<script>
					svgTexture(igorPlane, igorImg, igorCanvas)
				</script>

				<lume-plane
					id="numbersPlane"
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 75"
					opacity="0.99"
					Xtexture="./numbers.svg"
					color="white"
				>
					<div>
						<canvas id="numbersCanvas"></canvas>
						<img id="numbersImg" src="./numbers.svg" width="1294" height="2300" />
					</div>
				</lume-plane>
				<script>
					svgTexture(numbersPlane, numbersImg, numbersCanvas)
				</script>
			</lume-plane>
		</lume-node>

		<lume-node id="particleContainer" align-point="0.5 0.5" rotation="0 0 0">
			<lume-instanced-mesh
				has="plane-geometry phong-material"
				opacity="0.99"
				align-point="0.5 0.5"
				mount-point="0.5 0.5"
			></lume-instanced-mesh>
			<lume-instanced-mesh
				has="plane-geometry phong-material"
				opacity="0.99"
				align-point="0.5 0.5"
				mount-point="0.5 0.5"
			></lume-instanced-mesh>
		</lume-node>

		<lume-node id="play" class="showPause" size="60 60" align-point="1 0" mount-point="1 0">
			<lume-node size="20 20" align-point="1 0" mount-point="1 0" position="-10 10 0">
				<div class="triangle"></div>
				<div class="pause"></div>
			</lume-node>
		</lume-node>
	</lume-scene>

	<div class="rays"></div>

	<audio id="audio" src="./City of Silent Wishes.mp3" autoplay loop></audio>

	<script src="./index.js"></script>
</body>
