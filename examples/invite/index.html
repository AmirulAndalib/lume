<title>Игорь & Анна</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
	html,
	body {
		width: 100%;
		height: 100%;
		margin: 0;
		padding: 0;
		touch-action: none;
		user-select: none;
	}

	html {
		overflow: hidden;
		background-image: linear-gradient(
			159deg,
			rgb(228, 236, 232) 0%,
			rgb(220, 231, 226) 35%,
			rgb(201, 217, 209) 64%,
			rgb(127, 164, 145) 100%
		);
	}

	lume-scene {
		position: absolute;
		top: 0;
		left: 0;
	}

	lume-scene * {
		/* pointer-events: none; */
	}

	.rays {
		position: absolute;
		top: -140%;
		left: -140%;
		width: 250%;
		height: 250%;
		pointer-events: none;

		background-image: repeating-conic-gradient(hsla(0, 0%, 100%, 0.2) 0 5deg, hsla(0, 0%, 100%, 0) 0 15deg);
	}

	#fitted {
		/* background: #fbfaf4; */
	}

	img,
	div,
	div canvas {
		width: 100%;
		height: 100%;
		display: block;
	}

	div {
		overflow: hidden;
	}
	img {
		/* transform: scale(1.01); */

		/* tmp */
		position: absolute;
		top: 0;
		left: 105%;
	}

	#play {
		pointer-events: all;
	}

	:root {
		--green: #a3beb0;
	}

	.triangle {
		--size: 20;
		width: 0;
		height: 0;
		border-top: calc(1px * var(--size) / 2) solid transparent;
		border-bottom: calc(1px * var(--size) / 2) solid transparent;
		border-left: calc(1px * var(--size) / 2) solid var(--green);

		margin: auto;
	}

	.pause {
		display: none;
	}

	.pause::before,
	.pause::after {
		content: '';
		width: 20%;
		height: 80%;
		position: absolute;
		top: 50%;
		transform: translate(-50%, -50%);
		background: var(--green);
	}

	.pause::before {
		left: 30%;
	}

	.pause::after {
		left: 70%;
	}

	.showPause .pause {
		display: block;
	}
	.showPause .triangle {
		display: none;
	}
</style>

<body touch-action="none">
	<script src="../../dist/global.js"></script>
	<script>
		// Define all the LUME elements with their default names.
		LUME.useDefaultNames()
	</script>

	<!-- FIXME: this works if loaded here, but doesn't work if loaded after the
	 lume-scene markup. When loaded after the scene markup, _loadGL and similar
	 methods never fire. Maybe the ShadowDOM composition stuff needs to use
	 whenDefined() to wait for element definitions? -->
	<script src="./svg.js"></script>

	<lume-scene
		id="scene"
		perspective="800"
		webgl
		fog-mode="linear"
		fog-near="800"
		fog-far="1300"
		fog-color="#c3d5cc"
		swap-layers="true"
	>
		<lume-ambient-light color="white" intensity="0.8"></lume-ambient-light>

		<lume-point-light
			id="light"
			position="-960 -335 400"
			Xposition="0 0 400"
			align-point="0.5 0.5"
			intensity="0.6"
			color="white"
			shadow-radius="2"
			shadow-bias="-0.002"
		></lume-point-light>

		<lume-node
			id="fitter"
			size-mode="proportional proportional"
			size="0.9 0.9"
			align-point="0.5 0.5"
			mount-point="0.5 0.5"
		>
			<lume-node id="fitted" align-point="0.5 0.5" mount-point="0.5 0.5" size="647 1150" color="#eee">
				<!-- <lume-svg size="500 500" src="./and.svg"></lume-svg> -->

				<!-- <lume-node size-mode="proportional proportional" size="1 1" position="0 0 75">
					<div>
						<img src="./background-01.png" />
					</div>
				</lume-node>
				<lume-node size-mode="proportional proportional" size="1 1" position="0 0 60">
					<div>
						<img src="./text-01.2.svg" />
					</div>
				</lume-node>
				<lume-node size-mode="proportional proportional" size="1 1" position="0 0 90">
					<div>
						<img src="./anna.svg" />
					</div>
				</lume-node> -->

				<!-- <lume-svg-2
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 60"
					src="./and.svg"
				></lume-svg-2> -->
				<lume-plane
					id="andPlane"
					size-mode="proportional proportional"
					size="1 1"
					position="0 0 60"
					opacity="0.99"
					Xtexture="./and.svg"
					color="white"
				></lume-plane>
				<lume-node id="andNode" size-mode="proportional proportional" size="1 1" position="0 0 60">
					<div>
						<canvas id="andCanvas"></canvas>
						<img id="andImg" src="./and.svg" width="1294" height="2300" />
					</div>
				</lume-node>
				<script>
					///// Image to canvas then texture //////////////////////////////
					!(async function () {
						const ctx = andCanvas.getContext('2d')

						await Promise.all([
							new Promise(res => (andImg.onload = res)),
							new Promise(res => {
								if (andPlane._glLoaded) res()
								else andPlane.on('GL_LOAD', res)
							}),
						])

						console.log('IMAGE LOADED')
						andCanvas.width = 1294
						andCanvas.height = 2300
						ctx.drawImage(andImg, 0, 0, 1294, 2300)

						const tex = new LUME.THREE.CanvasTexture(andCanvas)
						andPlane.three.material.map = tex

						// Reset Three.js internal state or else sometimes WebGLRenderer does not render the texture.
						// TODO report Three.js r125 bug. When you see a flash of white and then the texture, that's when the bug normally happens if dispose() is not called, in which case the white material will stay and the texture will not appear.
						andPlane.three.material.dispose()
						andPlane.needsUpdate()

						// andPlane.visible = true

						// If we remove the canvas before the above creation of CanvasTexture, the texture will not render. hmmmm.
						andCanvas.remove()
					})()
				</script>

				<!-- <lume-node size-mode="proportional proportional" size="1 1" position="0 0 90">
					<div>
						<img src="./igor.svg" />
					</div>
				</lume-node>
				<lume-node size-mode="proportional proportional" size="1 1" position="0 0 75">
					<div>
						<img src="./numbers.svg" />
					</div>
				</lume-node> -->
			</lume-node>
		</lume-node>

		<lume-node visible="false" id="particleContainer" align-point="0.5 0.5" rotation="0 0 0">
			<lume-instanced-mesh
				has="plane-geometry phong-material"
				align-point="0.5 0.5"
				mount-point="0.5 0.5"
			></lume-instanced-mesh>
			<lume-instanced-mesh
				has="plane-geometry phong-material"
				align-point="0.5 0.5"
				mount-point="0.5 0.5"
			></lume-instanced-mesh>
		</lume-node>

		<lume-node id="play" class="showPause" size="60 60" align-point="1 0" mount-point="1 0">
			<lume-node size="20 20" align-point="1 0" mount-point="1 0" position="-10 10 0">
				<div class="triangle"></div>
				<div class="pause"></div>
			</lume-node>
		</lume-node>
	</lume-scene>

	<div class="rays"></div>

	<audio id="audio" src="./City of Silent Wishes.mp3" autoplay loop></audio>

	<script src="./index.js"></script>
</body>
