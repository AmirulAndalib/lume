<!DOCTYPE html>
<html>
    <head>
        <title> test </title>

        <style>
            body, html {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
        </style>

        <!-- version 1.1.1+ doesn't work with MutationObservers on ShadowDOM roots. -->
        <!-- <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.0.0/bundles/webcomponents-sd-ce.js"></script> -->
        <!-- <script src="https://unpkg.com/@webcomponents/webcomponentsjs@1.1.0/webcomponents-bundle.js"></script> -->

        <!-- version 1.1.0 is the last version where MutationObserver on a shadow root works. -->
        <!-- <script src="https://unpkg.com/@webcomponents/webcomponentsjs@1.1.0/webcomponents-sd-ce.js"></script> -->
        <script src="https://unpkg.com/@webcomponents/webcomponentsjs@1.1.0/webcomponents-lite.js"></script>
    </head>
    <body>

        <!-- Render something below the scene to test transparency -->
        <!--<style> i-scene {position:absolute!important; top:0; left:0;} </style>-->
        <!--<p>This is some text below the scene.</p>-->

        <!--This script only defines classes.-->
        <script src="./global.js"></script>

        <script>
            console.log('--- beginning of body')
        </script>

        <!-- BUTTONS WITH SHADOW ======================================================== -->

        <script src="https://unpkg.com/vue@2.5.11/dist/vue.js"></script>
        <script src="https://unpkg.com/tween.js@16.6.0/src/Tween.js"></script>

        <script>
            // infamous.html.useDefaultNames()
        </script>

        <style>
            body, html {
              font-family: sans-serif;
              touch-action: none;
            }
            i-node {
              text-align: center;
            }
            #bg {
              background: #62b997;
            }
            button {
              width: 100%;
              height: 100%;
              white-space: nowrap;
              border-radius: 0px;
              border: 1px solid #913503;
              background: #fc9156;
              color: #913503;
              outline: none;
            }
            button:focus,
            button:hover {
              background: #fa620f;
              color: #481a01;
              border-color: #742a02;
            }
        </style>

        <template vue>
            <!-- Lights and shadows are powered by WebGL, but written with HTML: -->
            <i-scene
                experimental-webgl="true"
                id="scene"
                background-color="black"
                background-opacity="0"
                style="perspective: 800px"
                shadowmap-type="pcfsoft"
                >

                <i-ambient-light color="#404040" intensity="1"></i-ambient-light>

                <i-dom-plane ref="plane" id="bg" size-mode="proportional proportional" size="1 1 0" color="#333">

                    <i-node
                        id="button-container"
                        position="0 0 6"
                        size="600 31 0"
                        align="0.5 0.5 0"
                        mount-point="0.5 0.5 0"
                        >
                        <i-dom-plane
                            v-for="n in [0,1,2,3,4]"
                            :key="n"
                            size-mode="literal proportional"
                            size="100 1 0"
                            :align="`${n*0.25} 0 0`"
                            :mount-point="`${n*0.25} 0 0`"
                            color="#333"
                            >
                            <button>button {{n+1}}</button>
                        </i-dom-plane>
                    </i-node>

                    <i-point-light
                        id="light"
                        color="white"
                        position="300 300 120"
                        size="0 0 0"
                        cast-shadow="true"
                        intensity="0.5"
                        >
                        <i-mesh
                            has="sphere-geometry basic-material"
                            size="10 10 10"
                            color="white"
                            receive-shadow="false"
                            cast-shadow="false"
                            style="pointer-events: none"
                            >
                        </i-mesh>
                    </i-point-light>

                </i-dom-plane>
            </i-scene>
        </template>

        <div id="root"></div>

        <script>
            // defines the default names for the HTML elements
            infamous.html.useDefaultNames()

            new Vue({
                el: '#root',
                template: document.querySelector('[vue]').innerHTML,
                mounted: function() {
                    // console.log(' &&&&&&&&&&&&&&&&& rotation:', this.$refs.plane.rotation)
                    // this.$refs.plane.rotation = (x,y,z) => [x,++y,z]
                    // this.$refs.plane.size = (x,y,z,t) => [x, Math.abs(Math.sin(t/1000)), z]

                    var light = document.querySelector('#light')
                    light.threeObject3d.shadow.radius = 3
                    light.threeObject3d.distance = 20000
                    light.threeObject3d.shadow.bias = 0.00001

                    // prevent default touch actions so we can move the light with touch
                    document.querySelector('html').setAttribute('touch-action', 'none')
                    document.querySelector('body').setAttribute('touch-action', 'none')

                    document.addEventListener('pointermove', function(e) {
                        e.preventDefault()
                        light.position.x = e.clientX
                        light.position.y = e.clientY
                    })

                    var Motor = infamous.core.Motor
                    var downTween, upTween, pressedButton

                    // On mouse down animate the button downward
                    document.addEventListener('pointerdown', function(e) {
                        if ( is( e.target, 'button' ) ) {

                            pressedButton = e.target

                            if (upTween) {
                                upTween.stop()
                                upTween = null
                            }

                            downTween = new TWEEN.Tween(e.target.parentNode.position)
                                .to({z: -6}, 75)
                                .start()
                                .onComplete(function () { downTween = null })

                            Motor.addRenderTask(function(time) {
                                if (!downTween) return false
                                downTween.update(time)
                            })

                        }
                    })

                    // On mouse up animate the button upward
                    document.addEventListener('pointerup', function(e) {
                        if ( pressedButton ) {

                            if (downTween) {
                                downTween.stop()
                                downTween = null
                            }

                            upTween = new TWEEN.Tween(pressedButton.parentNode.position)
                                .to({z: 0}, 75)
                                .start()
                                .onComplete(function() { upTween = null })

                            Motor.addRenderTask(function(time) {
                                if (!upTween) return false
                                upTween.update(time)
                            })

                        }
                    })

                    // The following is a temporary hack because opacity isn't
                    // exposed through the HTML API yet. work-in-progress...
                    var scene = document.querySelector('#scene')
                    setTimeout(function() {
                        Array.from( document.querySelectorAll('i-dom-plane') ).forEach(function(n) {
                            n.threeObject3d.material.opacity = 0.3
                        })

                        document.querySelector('#bg')
                            .threeObject3d.material.opacity = 0.3
                        document.querySelector('#bg')
                            .threeObject3d.material.dithering = true

                        scene._needsToBeRendered()
                    }, 0)

                    function is( el, selector ) {
                        if ( [].includes.call(
                            document.querySelectorAll( selector ),
                            el
                        ) ) return true
                        return false
                    }
                },
            })
        </script>

        <!-- WORKS ======================================================== -->

 <!--
        <style>
            i-dom-node { text-align: center; }
        </style>

        <!~~ works here ~~>
        <script>
            infamous.html.useDefaultNames()
        </script>

        <i-scene
            experimental-webgl="true"
            id="scene"
            TODO-perspective="800"
            backgroundColor="rgb(0,0,0)"
            backgroundOpacity="0"
            style="perspective: 800px; background: #252525"
            shadowmap-type="pcfsoft" // one of basic, pcf, pcfsoft
            >

            <i-ambient-light color="white" intensity="0.3"></i-ambient-light>

            <!~~<i-plane size-mode="proportional proportional" size="1 1 0" color="teal" rotation="0 71 0"></i-plane>~~>
            <!~~<i-mesh id="plane" has="plane-geometry phong-material" size-mode="proportional proportional" size="1 1 0" color="teal" rotation="0 71 0"></i-mesh>~~>

            <!~~ TODO FIXME using dom-plane instead of node makes time until first paint for WebGL much longer. Why? ~~>
            <!~~<i-node id="plane" size-mode="proportional proportional" size="1 1 0" style="background: #ddd" rotation="0 71 0"> <span>Hello</span> </i-node>~~>
            <!~~<i-dom-plane id="plane" size-mode="proportional proportional" size="1 1 0" style="background: #ddd" rotation="0 71 0"> <span>Hello</span> </i-dom-plane>~~>

            <i-dom-node size-mode="proportional proportional" size="1 1 0" style="background: #ddd">
                <h1> HTML content, with lighting and shadows! </h1>
                <i-dom-node position="0 100 10" size="70 21 0" align="0.5 0 0" mount-point="0.5 0 0">
                    <button> A button! </button>
                </i-dom-node>
            </i-dom-node>

            <i-node id="root" align="0.5 0 0.5" size="0 0 0" position="0 180 100">

                <i-dom-node
                    size="200 200 0"
                    mount-point="0.5 0 0.5"
                    opacity="0.5"
                    style="background: #A1D490">

                    <h1>Hello</h1>

                </i-dom-node>

                <i-sphere size="50 50 50" mount-point="0.5 0 0.5" position="60 120 80" color="#156289" material-opacity="0.9"></i-sphere>
                <i-plane size="50 50 50" mount-point="0.5 0 0.5" position="80 110 80" color="pink" rotation="0 30 0"></i-plane>

                <i-dom-node id="little" size="50 50 50" mount-point="0.5 0 0.5" position="20 120 110" rotation="1140 0 0" style="background: orange" material-opacity="0.3">
                    3D!

                    <i-dom-node id="little2" size="50 50 50" mount-point="0.5 0 0.5" position="20 120 110" style="background: skyblue" material-opacity="0.3">
                        Yeah!
                    </i-dom-node>

                </i-dom-node>

                <i-box id="cube" size="50 50 50" mount-point="0.5 0 0.5" position="-60 120 80" color="#246157"></i-box>

                <i-mesh id="lightMesh" has="sphere-geometry basic-material"
                    size="10 10 10" color="white"
                    position="10 0 130"
                    receive-shadow="false" cast-shadow="false"
                    >
                    <i-point-light id="light" color="white" position="0 0 0" size="0 0 0" intensity="0.5"></i-point-light>
                </i-mesh>

            </i-node>

        </i-scene>

        <script>
            /**
             * using prop functions
             */
            // lightMesh.position = (x,y,z,time) => [x, 100 * Math.sin(time * 0.002) + 100, z]
            // root.rotation = (x,y,z,time) => [x, 15 * Math.cos(time * 0.002), z]
            // cube.rotation = (x,y,z) => [++x, ++y, z]
            // //little.rotation = (x,y,z) => [++x, y, z]
            // little2.rotation = (x,y,z) => [++x, y, z]

            /**
             * using a render task
             */
            setInterval(t => { t = performance.now()
            // infamous.core.Motor.addRenderTask(t => {
                lightMesh.position.y = 100 * Math.sin(t * 0.002) + 100
                root.rotation.y = 15 * Math.cos(t * 0.002)
                cube.rotation.y++
                cube.rotation.x++
                //little.rotation.x++
                little2.rotation.x++
            }, 1000)
            // })
        </script>
 -->

        <!-- TEST ======================================================== -->
<!--
        TODO do we need this test?
        <!~~ works here ~~>
        <script>
            infamous.html.useDefaultNames()
        </script>

        <style>
            html, body { background: #333; }

            i-node { background: deeppink; border: 1px solid yellow }

            div {
                position: absolute; top: 50%; left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
            }
        </style>

        <i-scene
            experimental-webgl="true"
            backgroundColor="rgb(0,0,0)"
            backgroundOpacity="0"
        >
            <i-ambient-light color="white"></i-ambient-light>
            <i-node id="n"
                size-mode="proportional proportional"
                size="0.25 0.25"
                align="0.5 0.5"
                mount-point="0.5 0.5"
            >
                <!~~ TODO: align 1 places items at the front of the cube space, but the parent DOM element is rendered at the back of the cube space.
                Where should a DOM element (or Plane) be rendered in the cube space, and where is align 0 and 1 relative to it? ~~>
                <i-plane align="0.5 0.5 1" mount-point="0.5 0.5 0" size="100 250 0" position="0 0 1" id="a" color="cyan" map="BG_Map.png"></i-plane>
                <i-node  align="0.5 0.5 1" mount-point="0.5 0.5 0" size="100 250 0" position="0 250 2" id="b">HELLO</i-node>
            </i-node>
        </i-scene>

        <!~~ <script>
            infamous.html.useDefaultNames()
        </script> ~~>

        <script>
            const n = document.querySelector('#n')

            // TODO: document that it must be ++y and not y++
            // n.rotation = (x, y, z) => [x, ++y, z] // works
            // n.rotation = (x, y, z) => [x, y++, z] // doesn't work!
        </script>
 -->

        <!-- WORKS ======================================================== -->
        <i-scene
            experimental-webgl="true"
            backgroundColor="rgb(0,0,0)"
            backgroundOpacity="0"
        >
            <i-ambient-light color="white"></i-ambient-light>
            <i-node id="n">
                <i-plane size="100 250 0" color="white" map="BG_Map.png"></i-plane>
                <i-node size="100 250 0" position="0 250 0">hello</i-node>
            </i-node>
        </i-scene>
        <script>
            infamous.html.useDefaultNames()
            const n = document.querySelector('#n')
            <!-- n.rotation = (x, y, z) => [x, y++, z] -->
            infamous.core.Motor.addRenderTask(() => {
                n.rotation.y++
            })
        </script>

        <!-- WORKS ======================================================== -->
<!--
        <script>
            infamous.html.useDefaultNames()
        </script>

        <style>
            html, body { background: #333; }

            i-node { background: deeppink; }

            div {
                position: absolute; top: 50%; left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
            }
        </style>

        <i-scene>
            <i-node
                size-mode="proportional proportional"
                sizeMode="proportional proportional"
                size="0.75 0.75"
                align="0.5 0.5"
                mount-point="0.5 0.5"
                mountPoint="0.5 0.5"
            >
                <div> Hello 3D </div>
            </i-node>
        </i-scene>

        <script>
            const node = document.querySelector('i-node')
            node.rotation = ( x, y, z ) => [ x, ++y, z ] // increment Y rotation only
        </script>
 -->
        <!-- WORKS ======================================================== -->
            <!--
               -<i-scene experimental-webgl="true">
               -    <i-box size="10 10 10" has="basic-material" color="pink"></i-box>
               -    <i-perspective-camera
               -        active="true"
               -        fov="45"
               -        aspect="1.9"
               -        near="0.1"
               -        far="100"
               -        position="0 0 -10"
               -    ></i-perspective-camera>
               -</i-scene>
               -<script>
               -    infamous.html.useDefaultNames()
               -    const scene = document.querySelector('i-scene')
               -    const cam = document.querySelector('i-perspective-camera')
               -</script>
               -->

        <!-- WORKS ======================================================== -->
        <!--
           -<script>
           -    console.log('  ---- define elements ---- ')
           -    infamous.html.useDefaultNames()
           -</script>
           -<i-scene>
           -    <i-node size="100 100 100" rotation="30 30 30">
           -        <p> hello </p>
           -        <i-node sizeMode="proportional literal" size="0.5 100 100">
           -            <p> there </p>
           -        </i-node>
           -    </i-node>
           -</i-scene>
           -->

        <!-- WORKS ======================================================== -->
        <!--<i-scene>-->
        <!--    <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--        <p> hello </p>-->
        <!--    </i-node>-->
        <!--</i-scene>-->
        <!--<script>-->
        <!--    console.log('  ---- define elements ---- ')-->
        <!--    infamous.html.useDefaultNames()-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    console.log('  ---- define elements ---- ')-->
        <!--    infamous.html.useDefaultNames()-->
        <!--</script>-->
        <!--<script>-->
        <!--document.body.insertAdjacentHTML('beforeend', `-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--document.body.insertAdjacentHTML('beforeend', `-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->
        <!--<script>-->
        <!--    console.log('  ---- define elements ---- ')-->
        <!--    infamous.html.useDefaultNames()-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    setTimeout(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    }, 0)-->
        <!--</script>-->
        <!--<i-scene>-->
        <!--    <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--        <p> hello </p>-->
        <!--    </i-node>-->
        <!--</i-scene>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    setTimeout(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    }, 0)-->
        <!--</script>-->
        <!--<script>-->
        <!--document.body.insertAdjacentHTML('beforeend', `-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    setTimeout(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    }, 0)-->
        <!--</script>-->
        <!--<script>-->
        <!--document.write(`-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    console.log('  ---- define elements ---- ')-->
        <!--    infamous.html.useDefaultNames()-->
        <!--</script>-->
        <!--<script>-->
        <!--document.write(`-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--document.write(`-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->
        <!--<script>-->
        <!--    console.log('  ---- define elements ---- ')-->
        <!--    infamous.html.useDefaultNames()-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    Promise.resolve().then(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    })-->
        <!--</script>-->
        <!--<script>-->
        <!--document.write(`-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--document.write(`-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->
        <!--<script>-->
        <!--    Promise.resolve().then(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    })-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    Promise.resolve().then(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    })-->
        <!--</script>-->
        <!--<i-scene>-->
        <!--    <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--        <p> hello </p>-->
        <!--    </i-node>-->
        <!--</i-scene>-->

        <!-- WORKS ======================================================== -->
        <!--<i-scene>-->
        <!--    <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--        <p> hello </p>-->
        <!--    </i-node>-->
        <!--</i-scene>-->
        <!--<script>-->
        <!--    Promise.resolve().then(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    })-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    Promise.resolve().then(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    })-->
        <!--</script>-->
        <!--<script>-->
        <!--document.body.insertAdjacentHTML('beforeend', `-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--document.body.insertAdjacentHTML('beforeend', `-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->
        <!--<script>-->
        <!--    Promise.resolve().then(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    })-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--    Promise.resolve().then(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    })-->
        <!--</script>-->
        <!--<script>-->
        <!--document.body.insertAdjacentHTML('afterbegin', `-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->

        <!-- WORKS ======================================================== -->
        <!--<script>-->
        <!--document.body.insertAdjacentHTML('afterbegin', `-->
        <!--    <i-scene>-->
        <!--        <i-node absoluteSize="100 100 100" rotation="30 30 30">-->
        <!--            <p> hello </p>-->
        <!--        </i-node>-->
        <!--    </i-scene>-->
        <!--`)-->
        <!--</script>-->
        <!--<script>-->
        <!--    Promise.resolve().then(() => {-->
        <!--        console.log('  ---- define elements ---- ')-->
        <!--        infamous.html.useDefaultNames()-->
        <!--    })-->
        <!--</script>-->

        <script>
            console.log('--- end of body')
        </script>

    </body>
</html>
