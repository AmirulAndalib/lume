<script src="../../dist/global.js"></script>

<lume-scene
	id="scene"
	webgl
	fog-mode="linear"
	fog-far="10000"
	fog-color="skyblue"
	background-color="skyblue"
	background-opacity="1"
>
	<!-- /// LIGHTS //////////////////////////////////////////////////////////////// -->
	<lume-ambient-light color="white" intensity="0.6"></lume-ambient-light>
	<lume-point-light color="white" intensity="0.6" position="500 -500 -500"></lume-point-light>

	<!-- /// BISON ///////////////////////////////////////////////////////////////// -->
	<lume-node>
		<lume-gltf-model id="bison" src="./bison.gltf" scale="50 50 50" center-geometry></lume-gltf-model>

		<!-- /// CAMERA //////////////////////////////////////////////////////////////// -->
		<lume-camera-rig
			interactive="true"
			min-polar-angle="5"
			max-polar-angle="90"
			initial-polar-angle="40"
			position="0 0 -300"
		></lume-camera-rig>
	</lume-node>

	<!-- /// ROCKS ///////////////////////////////////////////////////////////////// -->
	<lume-node id="rocks">
		<lume-box
			id="rockProto"
			visible="false"
			size="100 100 100"
			position="0 100 -400"
			mount-point="0.5 1 0.5"
		></lume-box>
	</lume-node>

	<!-- /// TERRAIN /////////////////////////////////////////////////////////////// -->
	<lume-node id="terrain" position="0 0 -5400">
		<lume-gltf-model
			src="./terrain.gltf"
			scale="1 1 1"
			center-geometry
			position="-900 -1010 -10300"
		></lume-gltf-model>
		<lume-gltf-model src="./terrain.gltf" scale="1 1 1" center-geometry position="-900 -1010 0"></lume-gltf-model>
		<lume-gltf-model
			src="./terrain.gltf"
			scale="1 1 1"
			center-geometry
			position="-900 -1010 10300"
		></lume-gltf-model>
	</lume-node>
</lume-scene>

<style>
	html,
	body {
		width: 100%;
		height: 100%;
		margin: 0;
	}
	lume-scene {
		background: #222;
		touch-action: none;
	}
</style>

<script>
	LUME.useDefaultNames()

	const speedMultiplier = LUME.variable(1.5)

	setInterval(() => speedMultiplier(speedMultiplier() + 0.025), 1000)

	const speed = LUME.variable(0)

	LUME.autorun(() => speed(2000 * speedMultiplier()))

	const numberOfLanesOnEachSideOfMiddle = 1
	const laneOffset = 300

	// Infinite terrain animation
	{
		let lastTime = performance.now()

		LUME.Motor.addRenderTask(t => {
			const dt = t - lastTime

			for (let child = terrain.firstElementChild; child; child = child.nextElementSibling) {
				let z = child.position.z
				z += speed() * (dt / 1000)

				if (z >= 10300) z = -10300

				child.position.z = z
			}

			lastTime = t
		})
	}

	// Rock obstacle placement
	{
		const rockInterval = LUME.variable(0)

		LUME.autorun(() => rockInterval(1500 / speedMultiplier()))

		function randomRocks() {
			let lastTime = performance.now()

			const rock = rockProto.cloneNode()
			rocks.append(rock)

			rock.id = ''
			rock.setAttribute('visible', true)

			const numberOfLanes = numberOfLanesOnEachSideOfMiddle * 2 + 1

			const lane = Math.floor((numberOfLanes - 0.0000001) * Math.random())

			rock.setAttribute(
				'position',
				(lane == 0
					? -laneOffset * numberOfLanesOnEachSideOfMiddle
					: lane == 1
					? 0
					: laneOffset * numberOfLanesOnEachSideOfMiddle) + ' 100 -10000',
			)

			rock.position = (x, y, z, t) => {
				const dt = t - lastTime

				z += speed() * (dt / 1000)

				if (z >= 1000) {
					rock.remove()
					return false
				}

				lastTime = t

				return [x, y, z]
			}

			setTimeout(randomRocks, Math.max(rockInterval() * Math.random(), rockInterval() * 0.25))
		}

		randomRocks()
	}

	// Bison lane switching
	{
		let targetPos = 0

		document.addEventListener('keydown', event => {
			const key = event.key

			if (['ArrowRight', 'd', 'D'].includes(key)) {
				targetPos = Math.min(laneOffset * numberOfLanesOnEachSideOfMiddle, (targetPos += laneOffset))
			} else if (['ArrowLeft', 'a', 'A'].includes(key)) {
				targetPos = Math.max(-laneOffset * numberOfLanesOnEachSideOfMiddle, (targetPos += -laneOffset))
			}
		})

		bison.position = (x, y, z) => [x + 0.2 * (targetPos - x), y, z]
	}

	// Collision detection
	{
		bison.on('MODEL_LOAD', () => {
			const bisonBox = new LUME.THREE.Box3()

			scene.three.add(new LUME.THREE.BoxHelper(bison.three, 0xffff00))

			LUME.Motor.addRenderTask(() => {
				for (let rock = rocks.firstElementChild; rock; rock = rock.nextElementSibling) {
					const boxGeom = rock.three.geometry

					boxGeom.computeBoundingBox()
					bisonBox.setFromObject(bison.three)

					if (boxGeom.boundingBox.intersectsBox(bisonBox)) {
						console.log('COLLISION!!!!!!!!!!!!!!')
					}
				}
			})
		})
	}
</script>
